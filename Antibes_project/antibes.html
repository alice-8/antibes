<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DJ Clap Visualizer</title>
<style>
  html, body {margin:0;padding:0;overflow:hidden;background:#0a1428;}
  canvas {position:fixed;inset:0;width:100%;height:100%;cursor:crosshair;touch-action:none;}
  #video {position:fixed;top:20px;right:20px;width:240px;height:180px;border:3px solid #4dd2ff;border-radius:10px;display:none;z-index:100;box-shadow:0 4px 20px rgba(77,210,255,0.5);transform:scaleX(-1);}
  #controls {position:fixed;top:20px;left:20px;z-index:100;display:flex;gap:10px;flex-direction:column;}
  button {padding:12px 20px;border:none;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;transition:all 0.3s;box-shadow:0 2px 10px rgba(0,0,0,0.3);}
  #micBtn {background:#ff4d4d;color:white;}
  #micBtn:hover {background:#ff3333;transform:translateY(-2px);}
  #micBtn.active {background:#4dff88;}
  #cameraBtn {background:#4dd2ff;color:white;}
  #cameraBtn:hover {background:#33c5ff;transform:translateY(-2px);}
  #cameraBtn.active {background:#ffd24d;color:#0a1428;}
  #status {position:fixed;bottom:20px;left:20px;color:#4dd2ff;font-family:monospace;font-size:12px;z-index:100;background:rgba(10,20,40,0.8);padding:10px 15px;border-radius:5px;border:1px solid #4dd2ff;}
  #nowPlaying {position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);color:white;font-family:monospace;font-size:30px;z-index:200;text-align:center;text-shadow:2px 2px 10px #000;}
</style>
</head>
<body>

<canvas id="canvas"></canvas>
<video id="video" autoplay playsinline></video>

<div id="controls">
  <button id="micBtn">ðŸŽ¤ Start Mic</button>
  <button id="cameraBtn">ðŸ“· Start Camera</button>
</div>

<div id="status">
  <div>ðŸŽ¤ Mic: <span id="micStatus">OFF</span></div>
  <div>ðŸ“· Camera: <span id="camStatus">OFF</span></div>
  <div>ðŸ”Š Volume: <span id="volStatus">0.00</span></div>
</div>

<div id="nowPlaying">Now Playing: None</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>

<script>
// ---------------- Canvas / State ----------------
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const video=document.getElementById("video");
let dots=[], mouse={x:-1000,y:-1000}, fingerPositions=[], colorShift=0, lastVolume=0;

// ---------------- Audio ----------------
let audioContext=null, analyser=null, dataArray=null, audioSource=null, audioStream=null, micActive=false;

// DJ songs
const songs=[
  {file:"chocolate.mp3", theme:["#d9b38c","#f1d9b8","#cfa87a","#e3c4a3"]},
  {file:"rose.mp3", theme:["#ffb3ba","#ffdfdf","#ff8da1","#ffc0cb"]},
  {file:"bread.mp3", theme:["#f5e1a4","#edd9b0","#d6b67b","#e6cfa3"]},
  {file:"bake_a_pie.mp3", theme:["#ffd699","#ffcc99","#ffe5b4","#ffd27f"]},
  {file:"donut.mp3", theme:["#ffb3ba","#ffdfba","#ffffba","#baffc9"]}
];

songs.forEach(s=>s.audio=new Audio(s.file));

let currentSongIndex=-1;
let songPlaying=false;

// ---------------- Camera ----------------
let cameraStream=null, cameraActive=false, hands=null, camera=null;

// ---------------- UI ----------------
const micBtn=document.getElementById("micBtn");
const cameraBtn=document.getElementById("cameraBtn");
const micStatus=document.getElementById("micStatus");
const camStatus=document.getElementById("camStatus");
const volStatus=document.getElementById("volStatus");
const nowPlaying=document.getElementById("nowPlaying");

// ---------------- Callbacks ----------------
function onVolumeChange(vol){volStatus.textContent=vol.toFixed(2);}
function onClap(){colorShift+=30;}

// ---------------- Canvas Setup ----------------
function resizeCanvas(){canvas.width=window.innerWidth; canvas.height=window.innerHeight; initDots();}
function initDots(){
  dots=[];
  let colors=songs[currentSongIndex>=0?currentSongIndex:0].theme;
  for(let i=0;i<2000;i++){
    const x=Math.random()*canvas.width, y=Math.random()*canvas.height;
    dots.push({x,y,baseX:x,baseY:y,size:Math.random()*3+1, color:colors[Math.floor(Math.random()*colors.length)], vx:0, vy:0});
  }
}

// ---------------- Mouse ----------------
window.addEventListener("mousemove",(e)=>{mouse.x=e.clientX; mouse.y=e.clientY;});

// ---------------- Mic ----------------
async function startMic(){
  try{
    audioStream=await navigator.mediaDevices.getUserMedia({audio:true});
    audioContext=new (window.AudioContext||window.webkitAudioContext)();
    analyser=audioContext.createAnalyser();
    audioSource=audioContext.createMediaStreamSource(audioStream);
    analyser.fftSize=256;
    audioSource.connect(analyser);
    dataArray=new Uint8Array(analyser.frequencyBinCount);
    micActive=true; micBtn.textContent="ðŸŽ¤ Stop Mic"; micBtn.classList.add("active"); micStatus.textContent="ON";
  }catch(err){alert("Microphone access denied."); console.error(err);}
}
function stopMic(){
  if(audioSource) audioSource.disconnect();
  if(analyser) analyser.disconnect();
  if(audioContext && audioContext.state!=="closed") audioContext.close();
  if(audioStream) audioStream.getTracks().forEach(t=>t.stop());
  audioSource=analyser=audioContext=dataArray=audioStream=null;
  micActive=false; micBtn.textContent="ðŸŽ¤ Start Mic"; micBtn.classList.remove("active"); micStatus.textContent="OFF";
}
micBtn.addEventListener("click",()=>{micActive?stopMic():startMic();});

// ---------------- Camera ----------------
function onHandResults(results){
  fingerPositions=[];
  if(results.multiHandLandmarks){
    for(const landmarks of results.multiHandLandmarks){
      const fingertips=[4,8,12,16,20];
      for(const idx of fingertips){
        const landmark=landmarks[idx];
        const x=(1-landmark.x)*canvas.width;
        const y=landmark.y*canvas.height;
        fingerPositions.push({x,y});
      }
    }
  }
}
async function startCamera(){
  try{
    cameraStream=await navigator.mediaDevices.getUserMedia({video:{width:640,height:480}});
    video.srcObject=cameraStream; video.style.display="block";
    hands=new Hands({locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({maxNumHands:2, modelComplexity:1, minDetectionConfidence:0.5, minTrackingConfidence:0.5});
    hands.onResults(onHandResults);
    camera=new Camera(video,{onFrame:async()=>{await hands.send({image:video});}, width:640,height:480});
    camera.start();
    cameraActive=true; cameraBtn.textContent="ðŸ“· Stop Camera"; cameraBtn.classList.add("active"); camStatus.textContent="ON + Hand Tracking";
  }catch(err){alert("Camera access denied."); console.error(err);}
}
function stopCamera(){
  if(camera){camera.stop(); camera=null;}
  if(hands){hands.close(); hands=null;}
  if(cameraStream){cameraStream.getTracks().forEach(t=>t.stop());}
  video.srcObject=null; video.style.display="none"; cameraStream=null; cameraActive=false; fingerPositions=[];
  cameraBtn.textContent="ðŸ“· Start Camera"; cameraBtn.classList.remove("active"); camStatus.textContent="OFF";
}
cameraBtn.addEventListener("click",()=>{cameraActive?stopCamera():startCamera();});

// ---------------- Animation ----------------
function animate(){
  ctx.fillStyle="rgba(10,20,40,0.2)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  let volume=0;
  if(analyser && dataArray){
    analyser.getByteFrequencyData(dataArray);
    const avg=dataArray.reduce((a,b)=>a+b)/dataArray.length;
    volume=avg/255;
  }

  // Clap detection
  if(volume>0.15 && volume>lastVolume*1.3){
    onClap();

    // Stop current song
    if(songPlaying){songs[currentSongIndex].audio.pause(); songs[currentSongIndex].audio.currentTime=0;}

    // Next song
    currentSongIndex=(currentSongIndex+1)%songs.length;
    const nextSong=songs[currentSongIndex].audio;
    nextSong.play(); songPlaying=true;
    nowPlaying.textContent="Now Playing: "+songs[currentSongIndex].file.replace(".mp3","");

    nextSong.onended=()=>{songPlaying=false;};

    // Change dot colors for the new song
    const colors=songs[currentSongIndex].theme;
    dots.forEach(dot=>dot.color=colors[Math.floor(Math.random()*colors.length)]);
  }

  lastVolume=Math.max(0.01,volume);
  onVolumeChange(volume);

  dots.forEach(dot=>{
    const dx=mouse.x-dot.x, dy=mouse.y-dot.y, dist=Math.sqrt(dx*dx+dy*dy), maxDist=150;
    if(dist<maxDist){const force=(maxDist-dist)/maxDist; dot.vx-=(dx/dist)*force*5; dot.vy-=(dy/dist)*force*5;}
    for(const finger of fingerPositions){
      const fdx=finger.x-dot.x, fdy=finger.y-dot.y, fdist=Math.sqrt(fdx*fdx+fdy*fdy), fMaxDist=150;
      if(fdist<fMaxDist){const fforce=(fMaxDist-fdist)/fMaxDist; dot.vx-=(fdx/fdist)*fforce*5; dot.vy-=(fdy/fdist)*fforce*5;}
    }
    if(volume>0.02){const jitter=volume*25; dot.vx+=(Math.random()-0.5)*jitter; dot.vy+=(Math.random()-0.5)*jitter;}
    const spring=0.05*(1-volume*2); dot.vx+=(dot.baseX-dot.x)*spring; dot.vy+=(dot.baseY-dot.y)*spring;
    const friction=0.85+(volume*0.1); dot.vx*=friction; dot.vy*=friction;
    dot.x+=dot.vx; dot.y+=dot.vy;
    ctx.beginPath(); ctx.arc(dot.x,dot.y,dot.size+volume*5,0,Math.PI*2); ctx.fillStyle=dot.color; ctx.fill();
  });

  requestAnimationFrame(animate);
}

// ---------------- Boot ----------------
resizeCanvas();
window.addEventListener("resize",resizeCanvas);
animate();
</script>

</body>
</html>
